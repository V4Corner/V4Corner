from datetime import date, datetime
from sqlalchemy import Column, Date, DateTime, ForeignKey, Integer, String
from sqlalchemy.orm import relationship

from database import Base


class CheckIn(Base):
    """签到/打卡模型"""
    __tablename__ = "checkins"

    id: int = Column(Integer, primary_key=True, index=True)
    user_id: int = Column(Integer, ForeignKey("users.id"), nullable=False)
    checkin_date: date = Column(Date, nullable=False, index=True)
    fortune: str = Column(String(20), nullable=False)  # 大吉、中吉、小吉、末吉、凶
    created_at: datetime = Column(DateTime(timezone=True), default=datetime.utcnow)

    # 关系
    user = relationship("User", back_populates="checkins")


def generate_fortune() -> dict:
    """随机生成运势

    Returns:
        {
            "fortune": "大吉/中吉/小吉/中平/凶/大凶",
            "good": ["宜的事项1", "宜的事项2"],
            "bad": ["忌的事项1", "忌的事项2"]
        }
    """
    import random

    # 运势等级和概率
    fortune_levels = [
        ("大吉", 8),    # 8%
        ("中吉", 20),   # 20%
        ("小吉", 35),   # 35%
        ("中平", 25),   # 25%
        ("凶", 10),     # 10%
        ("大凶", 2),    # 2%
    ]

    # 根据概率选择运势
    fortunes, weights = zip(*fortune_levels)
    fortune = random.choices(fortunes, weights=weights)[0]

    # 宜的内容库
    good_activities = [
        ("早起", "赶得上早八的，都是勇士"),
        ("坐第一排", "让老师记住你的脸"),
        ("预习高数", "虽然可能也看不懂"),
        ("带充电宝", "教室插座是稀有资源"),
        ("选课抢课", "拼手速，更拼网速"),
        ("记笔记", "虽然课后可能再也不看"),
        ("上课举手", "答对加分，答错也不亏"),
        ("去图书馆", "假装学习，实则睡觉"),
        ("打印资料", "期末的时候你会感谢我"),
        ("整理书桌", "堆成山的书终于见了光"),
        ("写论文开头", "最难的一步已完成"),
        ("背重点", "临时抱佛脚，脚还挺香"),
        ("做小组作业", "但愿队友不摆烂"),
        ("交作业前一晚", "创造力达到巅峰"),
        ("喝咖啡通宵", "天亮时，你与太阳同在"),
        ("穿睡衣上课", "网课的最大福利"),
        ("下课直奔食堂", "晚一步，队排到门外"),
        ("点外卖", "食堂吃腻了，换换口味"),
        ("吃泡面加肠", "深夜学习的仪式感"),
        ("洗衣服", "攒了一周的袜子该清了"),
        ("晒被子", "抓住有阳光的周末"),
        ("整理网盘", "学习资料从入门到放弃"),
        ("关灯早睡", "明天一定不熬夜"),
        ("跑步打卡", "体育课的尊严由我守护"),
        ("去操场散步", "假装在校园偶像剧里"),
        ("参加社团活动", "加不加分不重要，主要是玩"),
        ("听讲座", "为了盖章，也为了空调"),
        ("写入党申请书", "思想要积极，格式要对齐"),
        ("帮室友带饭", "收获一句'爸爸'"),
        ("开黑五排", "输了怪队友，赢了夸自己"),
        ("看搞笑视频", "憋笑到内伤，老师还在讲"),
        ("发朋友圈仅分组可见", "有些话，只能给懂的人看"),
        ("整理照片", "回忆那么多，内存那么小"),
        ("换头像", "换个头像，换种心情"),
        ("网购教材", "买前以为会看，买后垫桌脚"),
        ("写实习简历", "虽然经历像张白纸"),
        ("看求职攻略", "焦虑中带着一丝希望"),
        ("练自我介绍", "'我是……呃……'"),
        ("整理邮箱", "垃圾邮件比正经邮件多"),
        ("设置勿扰模式", "谁也别想打断我的摸鱼"),
        ("翻墙出校", "哪怕只是去吃碗面"),
        ("坐校车", "比走路快，比打车穷"),
        ("拍校园猫", "今日云撸猫任务完成"),
        ("写日记", "'今天又是平凡的一天'"),
        ("整理收藏夹", "'马了等于会了'到'删了等于忘了'"),
        ("下载学习软件", "打开次数：1"),
        ("换壁纸", "新壁纸，新生产力"),
        ("清理聊天记录", "有些话，还是别留证据"),
        ("关掉消息提醒", "暂时与世界失联"),
        ("发呆五分钟", "脑子需要缓冲时间"),
    ]

    # 忌的内容库
    bad_activities = [
        ("翘早八", "点名虽迟但到"),
        ("坐最后一排", "容易成为老师的提问盲区（并不）"),
        ("忘带校园卡", "进不了门，吃不了饭，寸步难行"),
        ("上课刷手机", "一抬头，黑板已成天书"),
        ("相信'平时不考'", "老师的话，反着听更安全"),
        ("考前熬夜复习", "知识不进脑子，只进黑眼圈"),
        ("考试作弊", "监控在转，老师在盯，你在冒险"),
        ("选水课", "水课也可能淹死人"),
        ("迟交作业", "系统关闭那一刻，心也碎了"),
        ("依赖打印店", "考前一夜，排队到天明"),
        ("图书馆占座", "书在人不在，容易引发公愤"),
        ("借笔记", "别人的字，你可能看不懂"),
        ("小组作业当组长", "累成狗，还容易被骂"),
        ("相信'下周才答辩'", "通知：改明天了"),
        ("通宵赶论文", "写到日出，删到日落"),
        ("空腹喝咖啡", "心慌手抖，宛如触电"),
        ("穿拖鞋上课", "路上可能被踩掉"),
        ("下课慢悠悠", "食堂没菜，外卖超时"),
        ("点外卖不备注", "'不要香菜'变成'多放香菜'"),
        ("泡面忘加水", "干嚼面饼，人生新体验"),
        ("衣服混洗", "白T恤染成粉红色"),
        ("晒被子忘收", "晚上盖着露水入睡"),
        ("网盘塞满却不整理", "找文件像大海捞针"),
        ("睡前喝奶茶", "眼睛瞪得像铜铃"),
        ("体育课穿牛仔裤", "蹲不下，迈不开，宛如僵尸"),
        ("操场夜跑不带灯", "容易撞到情侣"),
        ("社团开会不记录", "说完等于忘了"),
        ("讲座睡觉打呼", "社死只需一秒"),
        ("抄别人思想汇报", "查重率百分百"),
        ("忘带钥匙", "在门口等室友等到地老天荒"),
        ("游戏连跪还继续", "气到砸键盘，明天还得修"),
        ("上课憋笑", "内伤等级+1"),
        ("发动态忘屏蔽老师", "有些话，不适合被看见"),
        ("照片不备份", "手机一丢，青春全无"),
        ("频繁换头像", "被好友问'你是谁'"),
        ("买二手书缺页", "考试重点恰好在那一页"),
        ("简历写'精通Office'", "被问到PPT动画怎么设置"),
        ("盲目跟风考研", "别人考你也考，但书没翻过"),
        ("自我介绍背稿", "一紧张全忘光"),
        ("邮箱不清理", "重要邮件被淹没"),
        ("全天勿扰", "错过通知，错过世界"),
        ("翻墙被逮", "写检讨还要拍照留念"),
        ("校车上睡觉", "坐过站，醒来已在荒郊"),
        ("逗猫不洗手", "被室友嫌弃三天"),
        ("日记写太详细", "怕被偷看，更怕自己回头看"),
        ("收藏夹从不打开", "'等我有空再看'≈'永远不看'"),
        ("装太多学习APP", "每个都用一次，然后闲置"),
        ("壁纸太花哨", "找不到桌面图标"),
        ("聊天记录不删", "手机内存告急，往事不堪回首"),
        ("全天在线秒回", "显得你很闲"),
        ("发呆一节课", "回过神来，老师已走远"),
        ("考前转发锦鲤", "鱼都游累了，你还没复习"),
        ("相信'考试简单'", "出成绩时眼泪掉下来"),
        ("熬夜写实验报告", "数据编得自己都信了"),
        ("上课偷偷吃早饭", "包子味飘满教室"),
        ("忘充校园网", "躺在床上与世隔绝"),
        ("夏天不开空调", "室友关系面临考验"),
        ("冬天不开暖气", "被窝以外皆是远方"),
        ("宿舍养宠物", "毕业时不知如何安置"),
        ("借校园贷", "还钱时才知道什么叫'社会险恶'"),
        ("考前求老师划重点", "老师：'我讲的都是重点'"),
        ("考试时偷看邻座", "发现他也在看你"),
        ("论文复制粘贴", "查重率99%，喜提重写"),
        ("答辩时顶嘴", "老师：'你再说一遍试试'"),
        ("穿正装面试却忘剪标签", "转身时露出价格牌"),
        ("实习时摸鱼被老板发现", "尴尬而不失礼貌的微笑"),
        ("毕业照闭眼", "青春留下永恒的黑历史"),
    ]

    # 随机选择 2 个宜和 2 个忌
    good_selected = random.sample(good_activities, 2)
    bad_selected = random.sample(bad_activities, 2)

    return {
        "fortune": fortune,
        "good": [{"title": item[0], "desc": item[1]} for item in good_selected],
        "bad": [{"title": item[0], "desc": item[1]} for item in bad_selected],
    }


def calculate_streak(checkin_dates: list[date]) -> int:
    """计算连续签到天数

    Args:
        checkin_dates: 按日期降序排列的签到日期列表

    Returns:
        当前连续签到天数
    """
    if not checkin_dates:
        return 0

    from datetime import timedelta

    today = date.today()
    yesterday = today - timedelta(days=1)

    # 检查最近一次签到是否是今天或昨天
    latest_checkin = checkin_dates[0]
    if latest_checkin != today and latest_checkin != yesterday:
        return 0

    # 计算连续天数
    streak = 1
    for i in range(len(checkin_dates) - 1):
        current_date = checkin_dates[i]
        next_date = checkin_dates[i + 1]

        # 如果下一天是当前日期的前一天，连续
        if next_date == current_date - timedelta(days=1):
            streak += 1
        else:
            break

    return streak
