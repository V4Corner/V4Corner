# 博客功能升级计划

**创建时间**: 2025-01-23
**状态**: v1.9.1 已完成媒体系统优化

---

## 📋 升级任务列表

### 1. 媒体系统优化 ✅ (v1.9.1)
- [x] 前端: 实时媒体文件大小统计
- [x] 前端: 纯文本字数统计（排除 HTML 标签）
- [x] 前端: 媒体文件数量统计（20个限制）
- [x] 前端: 博客卡片两行截断
- [x] 前端: 评论内容强制换行
- [x] 后端: 博客摘要优化（媒体占位符）
- [x] 后端: 新增媒体文件大小查询 API
- [x] 后端: 图片/视频上传改为流式处理
- [x] 优化: 图片 > 20MB 询问是否压缩
- [x] 优化: 视频检查剩余容量
- [x] 修复: 大文件上传临时文件丢失问题
- [x] 修复: 编辑页面媒体大小不显示问题
- [x] 测试: 验证媒体统计功能

**已完成功能**（v1.9.1）：
- ✅ 实时媒体统计（字数、数量、大小）
- ✅ 图片智能压缩询问（> 20MB）
- ✅ 视频容量检查（2GB 限制）
- ✅ 流式上传优化（1GB+ 文件）
- ✅ 博客摘要媒体占位符【图片】【视频】
- ✅ 评论长字符串强制换行

### 2. 搜索功能
- [ ] 后端: 添加搜索 API（支持标题、内容搜索）
- [ ] 前端: 添加搜索框组件
- [ ] 前端: 集成搜索到博客列表页
- [ ] 测试: 验证搜索功能

### 3. 草稿功能 ✅
- [x] 后端: Blog 模型添加 status 字段 (draft/published)
- [x] 后端: 迁移现有数据
- [x] 后端: 更新 API（草稿仅作者可见）
- [x] 前端: 添加草稿箱页面
- [x] 前端: 创建/编辑页面添加保存草稿功能
- [x] 测试: 验证草稿功能

### 4. 富文本编辑器 ✅
- [x] 选型: 选择富文本编辑器（TipTap / Lexical / 其他）→ 已选择 TipTap
- [x] 安装: 安装编辑器依赖
- [x] 后端: 添加图片/视频上传接口
- [x] 前端: 替换 CreateBlog/EditBlog 的编辑器
- [x] 前端: 添加工具栏（加粗、斜体、标题、列表等）
- [x] 前端: 添加富文本内容样式
- [x] 测试: 验证富文本编辑和渲染

**已完成功能**（v1.7.0）：
- ✅ TipTap 富文本编辑器集成
- ✅ 图片上传与自动压缩
- ✅ 视频上传与服务器端压缩（FFmpeg）
- ✅ 自动清理未使用媒体文件
- ✅ 文本格式化、链接、对齐等丰富功能

**已完成功能**（v1.8.0）：
- ✅ 草稿功能
- ✅ Blog 模型添加 status 字段
- ✅ 草稿仅作者可见
- ✅ 草稿箱页面

### 5. 评论系统 ✅
- [x] 后端: 创建 Comment 模型（支持楼中楼、软删除）
- [x] 后端: 创建 Comment Schema
- [x] 后端: 创建评论 API (CRUD + 排序)
- [x] 后端: 创建 Notification 模型（评论通知）
- [x] 后端: 创建通知 API
- [x] 前端: 创建 Comment 类型定义
- [x] 前端: 创建 Notification 类型定义
- [x] 前端: 创建评论/通知 API 客户端
- [x] 前端: 创建评论组件（支持嵌套、编辑、排序）
- [x] 前端: 创建通知组件
- [x] 前端: 集成评论到博客详情页
- [x] 前端: 添加通知中心
- [x] 测试: 验证评论和通知功能

**功能需求**:
- ✅ 楼中楼回复（parent_id，最多2层）
- ✅ 允许编辑评论（限时或无限）
- ✅ 排序方式：时间正序 / 时间倒序 / 热度排序
- ✅ 评论通知（被回复时通知）
- ✅ 软删除（评论内容显示为"已删除"，评论数减少）
- ✅ 级联删除（删除父评论时自动删除所有子评论）
- ✅ 孤儿评论处理（父评论删除后，子评论自动变为顶级评论）

### 6. 通知系统 ✅
- [x] 后端: 创建 Notification 模型
- [x] 后端: 创建 Notification Schema
- [x] 后端: 创建通知 API（列表、标记已读、清除）
- [x] 前端: 创建 Notification 类型定义
- [x] 前端: 创建通知 API 客户端
- [x] 前端: 创建通知中心组件
- [x] 前端: 添加通知铃铛图标
- [x] 测试: 验证通知功能

### 7. 点赞/收藏功能
- [ ] 后端: 创建 Like 模型（用户-博客关联）
- [ ] 后端: 创建 Favorite 模型（用户-博客关联）
- [ ] 后端: 添加点赞/收藏 API
- [ ] 后端: Blog 模型添加 likes_count 字段
- [ ] 前端: 创建相关类型定义
- [ ] 前端: 创建点赞/收藏 API 客户端
- [ ] 前端: 添加点赞/收藏按钮组件
- [ ] 前端: 添加我的收藏页面
- [ ] 测试: 验证点赞/收藏功能

---

## 🎯 实施进度

**v1.7.0 已完成**：
- ✅ 富文本编辑器（TipTap）
- ✅ 图片自动压缩
- ✅ 视频服务器端压缩
- ✅ 媒体文件自动清理

**v1.8.0 已完成**：
- ✅ 草稿功能
- ✅ 草稿箱页面

**v1.9.0 已完成**：
- ✅ 评论系统（楼中楼、编辑、删除、排序）
- ✅ 通知系统（评论通知、通知中心）
- ✅ 修复：评论删除后总数正确更新
- ✅ 修复：孤儿评论问题（父评论删除后子评论自动变为顶级评论）
- ✅ 修复：级联删除（删除父评论时自动删除所有子评论）

**v1.9.1 已完成**：
- ✅ 媒体系统优化（实时统计、容量检查、流式上传）
- ✅ 博客卡片两行截断
- ✅ 评论内容强制换行
- ✅ 修复：大文件上传临时文件丢失问题
- ✅ 修复：编辑页面媒体大小不显示问题

**下一步计划（v2.0.0）**：
- ⏳ 搜索功能
- ⏳ 点赞/收藏功能

---

## 📝 实施记录

### 2025-01-25
- ✅ 实现媒体系统优化（v1.9.1）
  - 前端：实时媒体文件大小统计
  - 前端：纯文本字数统计（排除 HTML 标签）
  - 前端：媒体文件数量统计（20个限制）
  - 后端：新增媒体文件大小查询 API (`POST /api/uploads/media/sizes`)
  - 后端：图片/视频上传改为流式处理（1MB/次分块）
  - 优化：图片 > 20MB 询问用户是否压缩
  - 优化：视频检查剩余容量（2GB 限制）
  - 前端：博客卡片两行截断（`-webkit-line-clamp: 2`）
  - 前端：评论内容强制换行（`word-break: break-word`）
  - 后端：博客摘要优化（媒体文件替换为【图片】【视频】占位符）
  - 修复：大文件上传临时文件丢失问题
  - 修复：编辑页面媒体大小不显示问题（异步加载）
- ✅ 更新项目文档（PROGRESS.md、API.md、BLOG_UPGRADE.md）

### 2025-01-23
- ✅ 创建任务计划文档
- ✅ 实现富文本编辑器功能（TipTap）
  - 后端：添加图片/视频上传接口
  - 前端：集成 TipTap 富文本编辑器
  - 支持功能：文本格式化、标题、列表、链接、图片、视频、对齐方式等
- ✅ 实现图片自动压缩（browser-image-compression）
- ✅ 实现视频服务器端压缩（FFmpeg + ffmpeg-python）
- ✅ 实现媒体文件自动清理功能
- ✅ 更新项目文档（README.md、PROGRESS.md）

### 2025-01-24
- ✅ 实现草稿功能（v1.8.0）
  - 后端：Blog 模型添加 status 字段
  - 后端：更新 API 草稿权限控制
  - 前端：添加草稿箱页面
  - 前端：创建/编辑页面添加保存草稿功能
- ✅ 实现评论系统（v1.9.0）
  - 后端：创建 Comment 模型（支持楼中楼、软删除）
  - 后端：创建评论 API（CRUD + 排序 + 分页）
  - 前端：创建评论组件（支持嵌套、编辑、删除、排序）
  - 前端：集成评论到博客详情页
  - 功能：楼中楼回复（最多2层）、编辑评论、删除评论（软删除）、3种排序方式
- ✅ 实现通知系统（v1.9.0）
  - 后端：创建 Notification 模型
  - 后端：创建通知 API（列表、标记已读、删除）
  - 前端：创建通知中心组件（下拉菜单）
  - 前端：添加通知铃铛图标到导航栏
  - 功能：3种通知类型（评论回复、博客评论、博客下的评论回复）
- ✅ 修复：评论删除后总数正确更新（使用 func.count 替代 query.count）
- ✅ 修复：孤儿评论处理（父评论已删除时，子评论自动作为顶级评论显示）
- ✅ 修复：级联软删除（删除父评论时，递归删除所有子评论）

---

## ⚠️ 注意事项

1. **数据库迁移**: 草稿功能需要修改 Blog 表结构
2. **类型同步**: 前后端类型定义必须保持一致
3. **权限控制**: 评论、点赞/收藏需要登录
4. **性能优化**: 搜索功能考虑添加索引
5. **兼容性**: 富文本编辑器需考虑移动端适配
6. **FFmpeg 配置**: 视频压缩功能需要 FFmpeg，详见 README.md 配置说明
