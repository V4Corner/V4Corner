# 博客系统升级详解

本文档记录博客系统的所有升级内容。

---

## v2.1.2 (2026-01-25) - 图标系统统一 🎨

### SVG 简笔线条风格

#### 搜索与筛选组件

**SearchBar.tsx**（搜索栏）
- 搜索放大镜：🔍 → SVG 圆形镜框 + 手柄线条
- 清除按钮：✕ → SVG 交叉线

**BlogFilters.tsx**（筛选面板）
- 升降序箭头：↓↑ → SVG 向下箭头（升序时旋转180°）
- 日历图标：📅 → SVG 日历框
- 方格视图：⊞ → SVG 四个方格（2×2）
- 列表视图：☰ → SVG 三条横线

**ActivityFeed.tsx**（最新动态）
- blog_created（发布博客）：文档编辑图标
- notice_published（发布通知）：喇叭图标
- checkin_streak（连续签到）：火焰图标
- checkin_first（首次签到）：五角星图标
- user_joined（用户加入）：人物 + 加号图标

### 设计规范

所有 SVG 图标采用统一参数：
- `stroke="currentColor"` - 继承文本颜色
- `strokeWidth="2"` - 统一线条粗细
- `fill="none"` - 无填充，纯线条
- `strokeLinecap="round"` + `strokeLinejoin="round"` - 圆角端点

### 视觉效果

- **搜索栏**：18px SVG，灰色 50% 透明度
- **筛选按钮**：16px SVG，黑色
- **动态图标**：18px SVG，黑色线条圆圈

---

## v2.1.1 (2026-01-25) - 限制系统与体验优化 🚦

### 每日限制系统

#### 博客发布限制
- **限制**：50条/天（仅计算发布状态）
- **草稿限制**：20条总容量
- **超限提示**：HTTP 429 + 中文错误信息
- **草稿发布**：从草稿发布时同样检查每日限制

#### 评论限制
- **限制**：500条/天
- **基于 UTC 时间**：每日 00:00:00 - 23:59:59 UTC

### 分页系统

#### 博客总览页
- **每页数量**：15条
- **导航按钮**：上一页/下一页
- **页码显示**："第 X 页 / 共 Y 页"
- **自动重置**：搜索/筛选时返回第一页
- **禁用逻辑**：首页/末页按钮自动禁用

### 编辑体验优化

#### 保存跳转逻辑
- **保存草稿**：跳转回草稿箱（`/blogs/drafts`）
- **取消按钮**：草稿返回草稿箱，已发布返回详情页
- **面包屑**：根据博客状态动态显示

#### 评论区优化
- **编辑框**：禁止手动调整大小（`resize: none`）
- **三个位置**：发表评论、回复评论、编辑评论

### 通知系统重构

#### 详情页布局
- 采用博客详情页样式
- 三段式结构：标题信息 / 分隔线 / 正文
- 显示更新时间（如果已编辑）
- 移除阅读量显示

#### 权限修复
- 移除 `current_user.role` 引用
- 只允许作者编辑/删除

#### "重要"标识
- **红圆圈**：替代文字标签
  - 列表页：8px 圆圈
  - 详情页：10px 圆圈
- **垂直对齐**：`marginTop: '-0.1rem'` + `verticalAlign: 'middle'`

---

## v2.1.0 (2026-01-25) - 搜索筛选系统 🔍📊

### 搜索功能

**关键词搜索**
- 支持标题和内容搜索
- 手动搜索按钮（防抖）
- 搜索结果统计

**API 参数**
- `q` - 搜索关键词
- 后端使用 SQL `LIKE` 查询

### 筛选功能

**排序选项**
- 发布时间（`created_at`）
- 浏览量（`views`）
- 点赞数（`likes`）
- 收藏数（`favorites`）

**排序方向**
- 升序（`asc`）
- 降序（`desc`）
- 一键切换

**日期范围筛选**
- 起始日期（`date_from`）
- 结束日期（`date_to`）
- 日期选择器

**重置筛选**
- 一键清除所有筛选条件
- 恢复默认状态

### 双视图模式

**网格视图**
- 卡片式布局
- 图文并茂

**列表视图**
- 紧凑布局
- 单边框容器，实线分隔
- 仅标题和内容可点击
- 作者名点击进入个人中心
- 20px 圆形头像

### SVG 图标系统

**点赞按钮**
- 红色爱心（空心/实心）
- 固定宽度 4.5rem
- 数字使用等宽字体

**收藏按钮**
- 黄色五角星（空心/实心）
- 固定宽度 4.5rem

**智能显示**
- 数量为 0：显示"点赞"/"收藏"
- 数量 > 0：显示数字

**乐观更新**
- 立即响应
- 失败自动回滚

### 卡片设计优化

**新布局**
- 头像和用户名移至底部
- 与日期、阅读量同行

**固定两行内容**
- `minHeight: 3.2rem`
- `-webkit-line-clamp: 2`

**紧凑间距**
- 元素间距 0.25rem
- 分隔符边距 0.15rem

**用户名限制**
- 最大宽度 7em
- 超出显示省略号

### 数字格式化

**大数字简化**
- 999：直接显示
- 1.2k：千（保留一位小数）
- 1.5M：百万（保留一位小数）
- 去除尾随零

### 数据库索引

**新增索引**
```sql
idx_blog_title         -- 标题搜索
idx_blog_created_at    -- 时间排序
idx_blog_views         -- 浏览量排序
idx_blog_likes         -- 点赞数排序
idx_blog_favorites     -- 收藏数排序
```

### 个人中心升级

**"TA的博客"页面**
- 应用相同设计
- 支持搜索和筛选
- 支持网格/列表视图切换
- 集成 SVG 图标和数字格式化

---

## 技术架构

### 前端组件

```
frontend/src/
├── components/
│   ├── SearchBar.tsx       # 搜索栏（手动提交）
│   ├── BlogFilters.tsx     # 筛选面板（排序、日期、视图切换）
│   ├── LikeButton.tsx      # 点赞按钮（SVG 图标）
│   ├── FavoriteButton.tsx  # 收藏按钮（SVG 图标）
│   ├── BlogCard.tsx        # 博客卡片（新布局）
│   └── ActivityFeed.tsx    # 最新动态（SVG 图标）
├── routes/
│   ├── Blogs.tsx           # 博客总览（分页）
│   └── BlogDetail.tsx      # 博客详情（优化布局）
└── utils/
    └── formatNumber.ts     # 数字格式化工具
```

### 后端接口

**博客列表接口**
```
GET /api/blogs/blogs
参数：
  - status: 'published' | 'draft'
  - q: 搜索关键词
  - sort_by: 排序字段
  - sort_order: 排序方向
  - date_from: 起始日期
  - date_to: 结束日期
  - page: 页码
  - size: 每页数量
```

**用户博客接口**
```
GET /api/users/{user_id}/blogs
参数：同上
认证：可选（获取点赞/收藏状态）
```

### 数据库变更

**每日限制**
- 创建博客时检查 `status='published'` 的当日数量
- 创建博客时检查 `status='draft'` 的总数量
- 创建评论时检查当日评论数量
- 基于 UTC 时间的 `created_at` 字段

**时间戳修复**
- `updated_at` 字段添加 `default=datetime.utcnow`

---

## 设计决策

- **手动搜索** - 避免频繁请求，用户主动触发
- **双视图模式** - 满足不同浏览偏好
- **SVG 图标** - 比 emoji 更清晰，支持动态样式
- **固定宽度** - 防止数字变化导致按钮跳动
- **数字格式化** - 大数字更易读，节省空间
- **分离限制逻辑** - 草稿不影响发布配额
- **自动跳转** - 保存草稿后返回草稿箱
- **统一图标风格** - 简笔线条，视觉一致性
